<script type="module">
    import { auth, db, doc, setDoc, onAuthStateChanged, scanLocalNetwork } from './firebase-config.js';

    // Check if the user is logged in
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("User is logged in:", user.uid);

            // Automatically scan the network when the page loads
            scanLocalNetwork().then(ips => {
                if (ips.length > 0) {
                    const ipAddressInput = document.getElementById('ip-address');
                    ipAddressInput.value = ips[0]; // Fill the first detected IP
                }
            });

            // Add an event listener for form submission
            document.getElementById('add-device-form').addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent the default form submission

                // Get input values from the form
                const deviceName = document.getElementById('device-name').value;
                const deviceType = document.getElementById('device-type').value;
                const ipAddress = document.getElementById('ip-address').value;

                console.log("Device Name:", deviceName);
                console.log("Device Type:", deviceType);
                console.log("IP Address:", ipAddress);

                try {
                    // Create a custom ID for the device
                    const deviceId = `device-${new Date().getTime()}`;
                    console.log("Device ID:", deviceId);

                    // Add the device data to Firestore
                    await setDoc(doc(db, 'devices', deviceId), {
                        user_id: user.uid,
                        device_name: deviceName,
                        device_type: deviceType,
                        ip_address: ipAddress,
                        status: 'Connected',
                        created_at: new Date()
                    });

                    console.log("Device added successfully!");
                    alert('Device added successfully!');
                    window.location.href = 'service.html';
                } catch (error) {
                    console.error('Error adding device: ', error);
                    alert('Failed to add device: ' + error.message);
                }
            });
        } else {
            console.log("User is not logged in.");
            alert('User not logged in!');
            window.location.href = 'index.html';
        }
    });
</script>
